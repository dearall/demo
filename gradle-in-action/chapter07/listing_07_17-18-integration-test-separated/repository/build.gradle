apply from: 'databaseSetup.gradle'

test {
//    reports.html.destination = file("$reports.html.destination/unit")
//    reports.junitXml.destination = file("$reports.junitXml.destination/unit")

    reports.html.outputLocation.fileValue reports.html.outputLocation.dir("unit").get().asFile
    reports.junitXml.outputLocation.fileValue reports.junitXml.outputLocation.dir("unit").get().asFile
}

sourceSets {
    integrationTest {
        java.srcDir file('src/integTest/java')
        resources.srcDir file('src/integTest/resources')
        compileClasspath = sourceSets.main.output + configurations.testRuntimeClasspath
        runtimeClasspath = output + compileClasspath

        println 'sourceSets.main.output:' + sourceSets.main.output
        println 'configurations.testRuntimeClasspath:' + configurations.testRuntimeClasspath
        println 'compileClasspath:'+compileClasspath

        println 'output:'+output
        println 'compileClasspath:'+compileClasspath
        println 'runtimeClasspath:'+runtimeClasspath
    }
}

task integrationTest(type: Test) {
    description = 'Runs the integration tests.'
    group = 'verification'
    testClassesDirs = sourceSets.integrationTest.output.classesDirs
    classpath = sourceSets.integrationTest.runtimeClasspath
    shouldRunAfter test

    println 'testClassesDirs:'+testClassesDirs
    println 'classpath:'+classpath

//    reports.html.destination = file("$reports.html.destination/integration")
//    reports.junitXml.destination = file("$reports.junitXml.destination/integration")
    reports.html.outputLocation.fileValue reports.html.outputLocation.dir("integration").get().asFile
    reports.junitXml.outputLocation.fileValue reports.junitXml.outputLocation.dir("integration").get().asFile

    dependsOn startAndPrepareDatabase
    finalizedBy stopDatabase
}

tasks.withType(Test) {
    testLogging {
        showStandardStreams = true
        exceptionFormat 'full'
        events "passed", "skipped", "failed"
    }
}

check.dependsOn integrationTest

dependencies {
    implementation project(':model')
    runtimeOnly 'com.h2database:h2:1.3.170'
    testImplementation 'junit:junit:4.13'
}